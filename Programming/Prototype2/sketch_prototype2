#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>

//600 is the 'maximum' pulse length count (out of 4096)
int wrist_fe_start = 420; // movement of the wrist from flexion to extension
int wrist_ef_start = 140; // movement of the wrist from extension to flexion
int wrist_ru_start = 420;  // movement of the wrist from radial to ulnar
int wrist_ur_start = 120; // movement of the wrist from ulnar to radial
int neutral_position = 270; 


///////////////////////////////////////////////////////
///////////////////    CONSTANTS    ///////////////////
///////////////////////////////////////////////////////

const int SERVOMIN = 140; // this value depends on the adjustment of the servos
const int SERVOMAX = 420; // this value depends on the adjustment of the servos
const int SCHRITTWEITE = 10; // setting up the step size of the servos
//SERVOMIN: 120; SERVOMAX: 420 --> maximaler Bereich eines Servos [180,410]
//Angabe in DEGREE statt in PULSELÄNGE: pulselength = map(degrees, 0, 180, SERVOMIN, SERVOMAX);

// There are two different adresses for the two Adafruit motor boards: pwm & pwm2
Adafruit_PWMServoDriver pwm1 = Adafruit_PWMServoDriver(0x40); // motor board 1 mit Servos von 11 - 35
Adafruit_PWMServoDriver pwm2 = Adafruit_PWMServoDriver(0x41); // motor board 1 mit Servos von 41 - 55

/* 
pwm1: 31(8),
pwm2: 41(0)  
wrist: motor board2 (pwm2) 
servo motors 51(pin4), 52(pin5), 53(pin6), 54(pin7)
*/

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  Serial.println("movement of the roboy hand");
  pwm1.begin();
  pwm2.begin();

  // Servos run at ~50 Hz updates
  pwm1.setPWMFreq(50);  
  pwm2.setPWMFreq(50); 
  yield();
}


//////////////////////////////////////////////////////////////////
//////////////////    Neutral position of the wrist     //////////
//////////////////    all tendons are streched         ///////////
//////////////////////////////////////////////////////////////////

void neutral_position_wrist(){
// Nullstelle wrist, 270 --> This is the position where the wrist is in a neutral position
    while (neutral_position = 270){
    pwm2.setPWM(6, 0, neutral_position); //53 servo motor / Pin 6
    pwm1.setPWM(8, 0, neutral_position); //31 servo motor / Pin 8
    pwm2.setPWM(7, 0, neutral_position); //54 servo motor / Pin 7
    pwm2.setPWM(1, 0, neutral_position); //42 servo motor / Pin 0
    }
  }

//////////////////////////////////////////////////////////////////
//////////////////    Movement for the wrist     /////////////////
//////////////////    flexion_extension_wrist   //////////////////
//////////////////////////////////////////////////////////////////
// Movement from flexion to extension = 70°

void flexion_extension_wrist(){
  int wrist_fe = wrist_fe_start;
  do
  {
    pwm2.setPWM(6, 0, wrist_fe); //53 servo motor / Pin 6
    pwm1.setPWM(8, 0, wrist_fe); //31 servo motor / Pin 8

    // blaue Tendons, for movement radial - ulnar
    pwm2.setPWM(7, 0, 270); //54 servo motor / Pin 7
    pwm2.setPWM(1, 0, 270); //42 servo motor / Pin 0

    Serial.println("flexion_extension_wrist: wrist fe");
    Serial.println(wrist_fe);
       wrist_fe-=SCHRITTWEITE;
       delay(10); // servo movement is reduced 
  } while (wrist_fe >= SERVOMIN && wrist_fe<=SERVOMAX);
}


//////////////////////////////////////////////////////////////////
//////////////////    Movement for the wrist     /////////////////
//////////////////    extension_flexion_wrist   //////////////////
//////////////////////////////////////////////////////////////////
// Movement from extension to flexion = 80°

void extension_flexion_wrist(){
   int wrist_ef = wrist_ef_start;
   do 
  {
    pwm2.setPWM(6, 0, wrist_ef); //53 servo motor / Pin 6
    pwm1.setPWM(8, 0, wrist_ef); //31 servo motor / Pin 8
    
    // blaue Tendons, for movement radial - ulnar
    pwm2.setPWM(7, 0, 270); //54 servo motor / Pin 7
    pwm2.setPWM(1, 0, 270); //42 servo motor / Pin 0
    
    Serial.println("extension_flexion_wrist: wrist ef");
    Serial.println(wrist_ef);
    wrist_ef+=SCHRITTWEITE;
    delay(10); // servo movement is reduced 
  } while (wrist_ef<= SERVOMAX && wrist_ef>= SERVOMIN);  
}

//////////////////////////////////////////////////////////////////
//////////////////    Movement for the wrist     /////////////////
//////////////////    ulnar_radial_wrist         /////////////////
//////////////////////////////////////////////////////////////////
// Movement from radial to ulnar = 20°

void ulnar_radial_wrist(){
  int wrist_ur = wrist_ur_start; // wrist_ur = 120
  int wrist_ru = wrist_ru_start; // wrist_ru = 420
  do
  {
    //Servo 54 und Servo 41 haben entgegengesetzte Werte!!!
    pwm2.setPWM(7, 0, wrist_ur); //54 servo motor / Pin 7
    pwm2.setPWM(1, 0, wrist_ru); //42 servo motor / Pin 0

    // orange tendons, for movement flexion - extension
    //pwm2.setPWM(6, 0, 140); //53 servo motor / Pin 6 
    //pwm1.setPWM(8, 0, 140); //31 servo motor / Pin 8 

    Serial.println("ulnar_radial_wrist Servo 42");
    Serial.println(wrist_ur);
    Serial.println("ulnar_radial_wrist Servo54");
    Serial.println(wrist_ru);
       wrist_ur-=SCHRITTWEITE;
       wrist_ru+=SCHRITTWEITE;
       delay(10); // servo movement is reduced 
  } while (wrist_ur >= SERVOMIN && wrist_ur<=SERVOMAX && wrist_ru >= SERVOMIN && wrist_ru <= SERVOMAX); 
}

//////////////////////////////////////////////////////////////////
//////////////////    Movement for the wrist     /////////////////
//////////////////    radial_ulnar_wrist        //////////////////
//////////////////////////////////////////////////////////////////
// Movement from radial to ulnar = 30°

void radial_ulnar_wrist(){
     int wrist_ru = wrist_ru_start; // wrist_ru = 420
     int wrist_ur = wrist_ur_start; // wrist_ur = 120
   do 
  {
    //Servo 54 und Servo 41 haben entgegengesetzte Werte!!!
    pwm2.setPWM(7, 0, wrist_ru); //54 servo motor / Pin 7
    pwm2.setPWM(1, 0, wrist_ur); //42 servo motor / Pin 0
    
    // orange tendons, for movement flexion - extension
    //pwm2.setPWM(6, 0, 140); //53 servo motor / Pin 6 
    //pwm1.setPWM(8, 0, 140); //31 servo motor / Pin 8
 
    Serial.println("radial_ulnar_wrist Servo 42");
    Serial.println(wrist_ur);
    Serial.println("radial_ulnar_wrist Servo 54");
    Serial.println(wrist_ru);
       wrist_ru+=SCHRITTWEITE;
       wrist_ur-=SCHRITTWEITE;
       delay(10); // servo movement is reduced 
  } while (wrist_ru>= SERVOMIN && wrist_ru<=SERVOMAX && wrist_ur >= SERVOMIN && wrist_ur <= SERVOMAX); 
}

//////////////////////////////////////////////////////////////////
//////////////////   void loop        ////////////////////////////
//////////////////   function call    ////////////////////////////
//////////////////////////////////////////////////////////////////

void loop() {

/*
//movement wrist
//flexion_extension_wrist(); // movement of the wrist from flexion to extension
delay(2000);
//extension_flexion_wrist(); // movement of the wrist from extension to flexion
delay(2000);
*/
//radial_ulnar_wrist(); // movement of the wrist from ulnar to radial
delay(2000);
//ulnar_radial_wrist(); // movement of the wrist from radial to ulnar
delay(2000); 
neutral_position_wrist(); 
delay(2000);

/*
//test for adjust the servo
pwm2.setPWM(7,0,120);
pwm2.setPWM(1,0, 420);
delay(2500);
*/


/*pwm2.setPWM(7, 0, 270); //54
pwm2.setPWM(0, 0, 270); //41

pwm2.setPWM(6, 0, 420); //53 middle value, 
pwm1.setPWM(8, 0, 120); //31 middle value, 
*/
}
